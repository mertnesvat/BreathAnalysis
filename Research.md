# Breath Analysis System — How It Works

## Overview

This system measures meditation quality by tracking two physiological signals:
1. **Breath patterns** — via a thermistor on the nose
2. **Heart rate variability (HRV)** — via a pulse oximeter on the finger

The data flows through four stages: **Sense → Send → Store → Analyze**.

---

## Stage 1: Sense (ESP32 + Sensors)

### Thermistor — Measuring Breath

A **10K NTC thermistor** sits near the nostril. As you breathe:
- **Exhale**: warm air heats the thermistor → resistance drops → ADC value drops
- **Inhale**: cool air cools the thermistor → resistance rises → ADC value rises

The ESP32's 12-bit ADC reads this as a value from 0-4095. Typical readings are 1600-2100, with each breath creating a ~20-40 count oscillation. Over a 1-minute session, you'll see ~10-15 smooth waves in the data.

```
Exhale  Inhale  Exhale  Inhale
  ╲      ╱╲      ╱╲      ╱
   ╲    ╱  ╲    ╱  ╲    ╱
    ╲  ╱    ╲  ╱    ╲  ╱
     ╲╱      ╲╱      ╲╱
```

**Baseline drift**: The thermistor slowly warms up during a session (nose heating), causing the baseline to drift downward by ~100+ ADC counts over 60 seconds. This drift must be removed before counting breaths (see Stage 4).

### MAX30102 — Measuring Heart Rate

The **MAX30102** pulse oximeter shines an IR LED through your fingertip and measures how much light is absorbed. With each heartbeat:
- **Systole** (heart contracts): more blood in the finger → more absorption → IR value drops
- **Diastole** (heart relaxes): less blood → less absorption → IR value rises

The pulsatile (AC) component is only **~1-2%** of the total DC signal. With IR values around 53,000-66,000, the actual heartbeat variation is only ~500-1300 counts — riding on top of a massive baseline.

```
IR Signal (zoomed in on AC component):
    ╱╲      ╱╲      ╱╲      ╱╲
   ╱  ╲    ╱  ╲    ╱  ╲    ╱  ╲     ← Each peak = one heartbeat
──╱    ╲──╱    ╲──╱    ╲──╱    ╲──   (~950ms apart at 63 BPM)
```

**ADC configuration**: The MAX30102 has an 18-bit ADC. We use `adcRange=16384` (not 4096) to prevent saturation. At 4096, the IR value maxes out at 262143 (all bits set), making the heartbeat invisible.

### Sampling Rate

The ESP32 reads both sensors every **50ms** (20 Hz) and packs them into a 14-byte binary packet:

```
[timestamp_ms (4B)] [thermistor (2B)] [ir_value (4B)] [red_value (4B)]
```

The `timestamp_ms` is milliseconds since session start, generated by the ESP32's `millis()` clock. This timestamp is critical — it's used for deduplication and all time-based calculations.

---

## Stage 2: Send (BLE → Phone)

### How BLE Notifications Work

The ESP32 acts as a BLE (Bluetooth Low Energy) **peripheral** that advertises as `BreathMonitor`. The phone connects as a **central** and subscribes to notifications on the sensor data characteristic.

```
ESP32 (Peripheral)                    Phone (Central)
─────────────────                    ────────────────
Advertise "BreathMonitor"    ←scan── Discover device
Accept connection            ──────→ Connect
                             ←───── Subscribe to notifications (CCCD write)
Every 50ms:
  Read sensors
  Pack 14-byte packet
  pSensorDataChar->notify()  ──────→ onValueReceived callback fires
                                     Parse bytes → BreathData object
                                     Add to session buffer
```

### The Duplication Problem (Fixed)

`flutter_blue_plus` would emit the same characteristic value multiple times between firmware updates (4-7x duplication). This was fixed by:
- **App-side**: Skip samples with the same `timestamp_ms` as the last buffered sample
- **Cloud Function**: Deduplicate by timestamp before analysis (safety net)

### Session Control

The phone sends single-byte commands to the control characteristic:
- `0x01` = Start recording (firmware resets session timer)
- `0x02` = Stop recording
- `0x03` = Pause
- `0x04` = Resume

---

## Stage 3: Store (Phone → Firebase)

When a session ends, the phone:

1. **Converts** the sample buffer to compact arrays: `[[timestamp, therm, ir, red], ...]`
2. **Compresses** with gzip (~85% size reduction)
3. **Uploads** to Firebase Storage as `breath_sessions/{userId}/{sessionId}/raw_samples.gz`
4. **Creates** a Firestore document with session metadata (duration, start time, technique)
5. **Calls** the `recalculateBreathSession` Cloud Function to analyze the data

Typical sizes:
- 1-minute session: ~1,200 samples → ~50KB JSON → ~8KB gzipped

---

## Stage 4: Analyze (Cloud Function)

The Cloud Function receives the raw samples and computes metrics in two pipelines:

### Breath Analysis Pipeline

```
Raw thermistor
    │
    ▼
[Moving Average] ── 0.5 second window (10 samples)
    │                Smooths out noise from ADC jitter
    ▼
[Baseline Removal] ── 15 second moving average
    │                  Removes slow drift (nose warming up)
    │                  Preserves breath oscillations (~5s period)
    ▼
[Peak Detection] ── findPeaks(minDistance=1.5s, prominence=0.3×std)
    │                Each peak = one breath
    ▼
breathCount, breathRate (breaths/min), breathRegularity
```

**Why baseline removal matters**: Without it, a session where the thermistor drifts from 1900 to 1700 looks like one big downhill slope. The peak detector sees the slope as the dominant feature and misses the actual breaths riding on top. The 15-second moving average tracks the drift while letting each 3-5 second breath cycle stand out.

### HRV Analysis Pipeline

```
Raw IR signal
    │
    ▼
[Baseline Removal] ── 2.5 second moving average subtracted
    │                  Removes breathing modulation (~5s) and DC
    │                  Preserves cardiac signal (~1s period)
    ▼
[Smoothing] ── 3-sample moving average
    │           Reduces high-frequency noise
    ▼
[Invert] ── multiply by -1
    │        (pulse is inverted in IR: more blood = more absorption = lower IR)
    ▼
[Normalize] ── z-score (subtract mean, divide by std)
    │
    ▼
[Peak Detection] ── findPeaks(minDistance=0.35s, prominence=0.3×std)
    │                Each peak = one heartbeat (R-wave)
    ▼
[RR Intervals] ── time between consecutive peaks
    │              Filtered to 333-1500ms (40-180 BPM range)
    ▼
HRV Metrics:
  - avgHeartRate = 60000 / mean(RR)
  - SDNN = std(RR intervals)         ← overall variability
  - RMSSD = RMS of successive diffs  ← beat-to-beat variability
  - pNN50 = % of intervals differing by >50ms from previous
```

### Peak Detection Algorithm (`findPeaks`)

For each sample point:
1. **Local maximum?** — Is it higher than both neighbors?
2. **Prominent enough?** — Is the height above the nearest trough greater than `threshold × std`?
3. **Far enough from last peak?** — Enforces minimum distance (prevents double-counting)

```
Signal:  ···╱╲···╱╲···╱╲···
              ↑     ↑     ↑
            peak  peak  peak

Prominence = peak height - max(left_trough, right_trough)
Must exceed threshold × std to be counted
```

---

## Known Issues

### LED Optical Crosstalk Destroys HRV (Solved)

The breath-reactive red COB LED strip was physically contaminating the MAX30102 sensor readings. The LED light reached the photodiode, adding a massive PWM-modulated signal that overwhelmed the cardiac waveform.

**Experimental proof** (both sessions on battery power):

| Condition | IR Range | pulseStd | HR Peaks | RMSSD |
|-----------|----------|----------|----------|-------|
| LED ON | 4,037 - 71,426 (67K swing!) | 3,566 | 3 | 0 |
| LED OFF | 68,240 - 71,270 (3K swing) | 148 | 63 | 74.4 ms |

With the LED ON, the IR signal swings by 67,000 counts — the red/near-IR light from the COB strip floods the photodiode. With the LED OFF, the range tightens to 3,000 counts and heartbeats become clearly visible.

**Root cause**: The warm white COB LED (2200K color temperature) emits strongly in red (~660nm) and near-infrared wavelengths — exactly what the MAX30102 measures. The PWM switching (on/off cycling) creates an alternating light signal that the photodiode picks up as a huge AC component, drowning out the ~1% pulsatile cardiac signal.

**This was optical interference, not electrical power noise.** The 100µF capacitor and power regulation were fine all along.

**Solutions for PCB design**:
- Physically separate the LED from the MAX30102 (opposite side of enclosure)
- Add an opaque light barrier between LED and sensor
- Use a green/blue LED instead of warm white/red (avoid 660nm and 880nm wavelengths)
- Design the finger clip to block all ambient light from the photodiode

### Thermistor is Unaffected by LED

The thermistor measures temperature (resistance change), not light. LED optical interference doesn't affect it.

---

## Data Flow Summary

```
┌─────────────┐     BLE 20Hz      ┌──────────┐    gzip+upload    ┌──────────┐
│  ESP32 +    │ ──────────────────→│  Flutter  │ ────────────────→│ Firebase │
│  Sensors    │   14-byte packets  │   App     │                  │ Storage  │
│             │                    │           │                  │          │
│ Thermistor  │   ← BLE commands   │ Dedup by  │   Cloud Function │ Firestore│
│ MAX30102    │     (start/stop)   │ timestamp │ ←─── triggered ──│ (metrics)│
└─────────────┘                    └──────────┘                  └──────────┘
                                                                      │
                                                              ┌───────┴────────┐
                                                              │ Breath Pipeline │
                                                              │ • Smooth        │
                                                              │ • Detrend       │
                                                              │ • Peak detect   │
                                                              ├────────────────┤
                                                              │ HRV Pipeline    │
                                                              │ • Bandpass-like │
                                                              │ • Normalize     │
                                                              │ • Peak detect   │
                                                              │ • RR intervals  │
                                                              └────────────────┘
```

---

## Session Metrics Computed

| Metric | Unit | Meaning |
|--------|------|---------|
| breathCount | count | Number of breaths detected |
| avgBreathRate | breaths/min | Average breathing rate |
| breathRateStart | breaths/min | Rate in first third of session |
| breathRateEnd | breaths/min | Rate in last third of session |
| breathRegularity | 0-1 | How consistent the breath intervals are |
| heartbeatCount | count | Number of heartbeats detected |
| avgHeartRate | BPM | Average heart rate |
| SDNN | ms | Standard deviation of heartbeat intervals |
| RMSSD | ms | Root mean square of successive differences |
| pNN50 | % | Percentage of intervals differing >50ms |
| rmssdTrend | ratio | Change in RMSSD from start to end of session |
| fingerContactPercent | % | How much of the session had finger on sensor |
| score | 0-100 | Composite meditation quality score |
